# 实验设计文档

## 1. 实验概述

本实验旨在研究移动端人脸识别应用中不同计算划分策略对系统性能的影响。

### 1.1 研究问题

1. 不同计算划分方式如何影响端到端延迟？
2. 网络条件（WiFi vs 4G/5G）对各划分方案的影响？
3. 什么情况下应该选择本地执行 vs 云端卸载？
4. 数据传输量与计算复杂度的权衡？

### 1.2 实验假设

- H1: 计算密集型任务（FaceNet 嵌入生成）卸载到云端可以减少移动端能耗
- H2: 在低延迟网络环境下，云端卸载可以获得更低的端到端延迟
- H3: 数据传输量是决定卸载收益的关键因素

## 2. 实验变量

### 2.1 自变量 (Independent Variables)

| 变量 | 取值范围 | 说明 |
|------|---------|------|
| 计算划分模式 | Mode 0-4 | 见下方划分方案 |
| 网络类型 | WiFi, 4G, 5G | 不同网络条件 |
| 服务器位置 | 本地局域网, 云服务器 | 网络延迟不同 |
| 数据库大小 | 10, 50, 100, 500 条记录 | 影响搜索时间 |
| 图像质量 | 50%, 75%, 85%, 100% | JPEG 压缩质量 |

### 2.2 因变量 (Dependent Variables)

| 变量 | 单位 | 测量方法 |
|------|------|---------|
| 端到端延迟 | 毫秒 (ms) | 从输入帧到输出结果的时间 |
| 人脸检测时间 | ms | MediaPipe 检测耗时 |
| 嵌入生成时间 | ms | FaceNet 推理耗时 |
| 向量搜索时间 | ms | 数据库查询耗时 |
| 网络传输时间 | ms | 数据往返时间 |
| 服务器处理时间 | ms | 云端计算耗时 |
| 数据传输量 | KB | 单次请求数据大小 |

### 2.3 控制变量 (Control Variables)

- 测试图像：使用固定的测试图像集
- 测试设备：固定的 Android 手机型号
- 服务器配置：固定的服务器硬件配置
- 测试次数：每组实验重复 100 次取平均

## 3. 计算划分方案

### Mode 0: 全本地执行 (Baseline)

```
┌─────────────────────────────────────────────────────┐
│                    移动设备                          │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐          │
│  │人脸检测   │→│嵌入生成   │→│向量搜索   │→ 结果    │
│  │MediaPipe │  │FaceNet   │  │ObjectBox │          │
│  └──────────┘  └──────────┘  └──────────┘          │
└─────────────────────────────────────────────────────┘
```

**特点**：
- 无网络通信
- 完全离线工作
- 基准对比方案

### Mode 1: 嵌入生成卸载

```
┌─────────────────────────────────────────────────────┐
│                    移动设备                          │
│  ┌──────────┐                    ┌──────────┐      │
│  │人脸检测   │                    │向量搜索   │→结果 │
│  │MediaPipe │                    │ObjectBox │      │
│  └────┬─────┘                    └────▲─────┘      │
│       │ 裁剪图像 (~50KB)              │ 嵌入向量   │
└───────┼───────────────────────────────┼────────────┘
        │                               │
        ▼                               │
┌───────────────────────────────────────┴────────────┐
│                    云端服务器                        │
│                  ┌──────────┐                       │
│                  │嵌入生成   │                       │
│                  │FaceNet   │                       │
│                  └──────────┘                       │
└─────────────────────────────────────────────────────┘
```

**数据传输**：
- 上行：裁剪的人脸图像 (~50KB @ 85% JPEG)
- 下行：512维浮点向量 (~2KB)

### Mode 2: 向量搜索卸载

```
┌─────────────────────────────────────────────────────┐
│                    移动设备                          │
│  ┌──────────┐  ┌──────────┐                        │
│  │人脸检测   │→│嵌入生成   │                → 结果   │
│  │MediaPipe │  │FaceNet   │                        │
│  └──────────┘  └────┬─────┘                ▲       │
│                     │ 嵌入向量 (~2KB)       │       │
└─────────────────────┼──────────────────────┼───────┘
                      │                      │
                      ▼                      │
┌─────────────────────────────────────────────────────┐
│                    云端服务器                        │
│                  ┌──────────┐                       │
│                  │向量搜索   │                       │
│                  │FAISS/DB  │                       │
│                  └──────────┘                       │
└─────────────────────────────────────────────────────┘
```

**数据传输**：
- 上行：512维浮点向量 (~2KB)
- 下行：搜索结果 (~0.1KB)

### Mode 3: 嵌入+搜索卸载

```
┌─────────────────────────────────────────────────────┐
│                    移动设备                          │
│  ┌──────────┐                                      │
│  │人脸检测   │                              → 结果  │
│  │MediaPipe │                              ▲       │
│  └────┬─────┘                              │       │
│       │ 裁剪图像 (~50KB)                    │       │
└───────┼────────────────────────────────────┼───────┘
        │                                    │
        ▼                                    │
┌────────────────────────────────────────────────────┐
│                    云端服务器                        │
│  ┌──────────┐  ┌──────────┐                        │
│  │嵌入生成   │→│向量搜索   │                        │
│  │FaceNet   │  │FAISS/DB  │                        │
│  └──────────┘  └──────────┘                        │
└────────────────────────────────────────────────────┘
```

**数据传输**：
- 上行：裁剪的人脸图像 (~50KB)
- 下行：搜索结果 + 嵌入向量 (~2KB)

### Mode 4: 全流程卸载

```
┌─────────────────────────────────────────────────────┐
│                    移动设备                          │
│                                            → 结果   │
│       │ 完整帧 (~200KB)                    ▲       │
└───────┼────────────────────────────────────┼───────┘
        │                                    │
        ▼                                    │
┌────────────────────────────────────────────────────┐
│                    云端服务器                        │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐          │
│  │人脸检测   │→│嵌入生成   │→│向量搜索   │          │
│  │MediaPipe │  │FaceNet   │  │FAISS/DB  │          │
│  └──────────┘  └──────────┘  └──────────┘          │
└────────────────────────────────────────────────────┘
```

**数据传输**：
- 上行：完整相机帧 (~200-500KB)
- 下行：检测结果 + 识别结果 (~1KB)

## 4. 实验环境

### 4.1 移动设备

| 设备 | 规格 |
|------|------|
| 型号 | [填写你的设备型号] |
| CPU | [填写 CPU 信息] |
| RAM | [填写内存大小] |
| Android 版本 | [填写版本] |

### 4.2 云端服务器

| 配置项 | 规格 |
|--------|------|
| CPU | [建议：4核+] |
| RAM | [建议：8GB+] |
| GPU | [可选] |
| 操作系统 | Ubuntu 20.04+ |
| Python | 3.9+ |

### 4.3 网络环境

| 网络类型 | 测试条件 |
|---------|---------|
| WiFi (局域网) | 同一路由器下 |
| WiFi (互联网) | 通过云服务器 |
| 4G | 移动数据网络 |
| 5G | 5G 移动数据网络 |

## 5. 实验步骤

### 5.1 环境准备

```bash
# 1. 启动云端服务器
cd server
python3 -m venv venv
source venv/bin/activate
pip install -r requirements.txt

# 复制模型文件
mkdir -p models
cp ../app/src/main/assets/facenet_512.tflite models/
cp ../app/src/main/assets/blaze_face_short_range.tflite models/

# 启动服务
uvicorn main:app --host 0.0.0.0 --port 8000
```

### 5.2 配置 Android 客户端

```kotlin
// 在 OffloadingConfig.kt 中配置服务器地址
OffloadingConfig.serverHost = "192.168.1.xxx"  // 你的服务器 IP
OffloadingConfig.serverPort = 8000
```

### 5.3 添加网络权限

确保 `AndroidManifest.xml` 包含：

```xml
<uses-permission android:name="android.permission.INTERNET" />
<uses-permission android:name="android.permission.ACCESS_NETWORK_STATE" />
```

### 5.4 执行测试

对于每种划分模式，执行以下测试：

1. **基准测试**：运行 100 次人脸识别，记录各项指标
2. **变化网络测试**：在不同网络条件下重复测试
3. **变化数据库大小**：添加不同数量的人脸后测试

### 5.5 数据收集

使用 `PerformanceLogger` 收集数据，导出为 CSV 格式进行分析。

## 6. 预期结果分析

### 6.1 性能对比表 (预期)

| 模式 | 本地计算时间 | 网络时间 | 总延迟 | 数据传输 |
|------|------------|---------|--------|---------|
| Mode 0 | ~200ms | 0ms | ~200ms | 0KB |
| Mode 1 | ~100ms | ~50-200ms | ~150-300ms | ~52KB |
| Mode 2 | ~150ms | ~20-50ms | ~170-200ms | ~2KB |
| Mode 3 | ~50ms | ~50-200ms | ~100-250ms | ~52KB |
| Mode 4 | ~10ms | ~100-500ms | ~110-510ms | ~200KB |

### 6.2 分析维度

1. **延迟分析**：各模式的平均延迟、延迟分布
2. **带宽影响**：不同带宽下各模式的表现
3. **网络稳定性**：延迟抖动对各模式的影响
4. **能耗分析**：各模式的移动端计算量对比

## 7. 演示检查清单

### 7.1 演示前准备

- [ ] 服务器正常运行
- [ ] Android 应用安装完成
- [ ] 人脸数据库已初始化（添加 3-5 个人脸）
- [ ] 网络连接稳定
- [ ] 性能日志已清空

### 7.2 演示流程

1. **展示 Mode 0 (全本地)**
   - 演示基本人脸识别功能
   - 展示实时性能指标

2. **展示 Mode 1 (嵌入卸载)**
   - 切换模式
   - 对比性能变化
   - 说明数据传输内容

3. **展示 Mode 2 (搜索卸载)**
   - 说明云端数据库同步
   - 对比性能

4. **展示 Mode 3 (嵌入+搜索)**
   - 对比与前两种模式的差异

5. **展示性能日志**
   - 导出 CSV
   - 展示统计数据

### 7.3 常见问题准备

1. Q: 为什么选择这个应用？
   A: 人脸识别是典型的计算密集型、延迟敏感应用，适合研究计算划分问题。

2. Q: 如何选择最优划分方案？
   A: 取决于网络条件、计算需求和延迟要求的权衡。

3. Q: 云端执行有什么优势？
   A: 减少移动端能耗、可利用更强计算资源、支持更大规模数据库。

4. Q: 云端执行有什么劣势？
   A: 依赖网络连接、增加延迟、隐私考虑。

